{% include "nginx/conf.d/common.conf.twig" with _context %}

map $cookie_XDEBUG_SESSION $xdebug_mode {
    ""      "";
    default "_xdebug";
}

map $cookie_XDEBUG_SESSION $xdebug_port {
    ""      "9000";
    default "9001";
}

server {
    server_name _; # This is just an invalid value which will never trigger on a real hostname.
    listen 80;
    access_log /var/log/nginx/access.log vhost;
    return 502;
}

{% for groupData in groups %}
{% for applicationName, applicationData in groupData['applications'] %}
{% if applicationData['application'] == 'zed' %}

{% for endpoint, endpointData in applicationData['endpoints'] %}
{# Ignoring custom port and SSL within internal networn #}
{% include "nginx/http/rpc.server.conf.twig" with {
    endpoint: endpoint,
    endpointData: endpointData,
    storeServices: regions[groupData['region']]['stores'][endpointData['store']]['services'] | default([]),
    upstream: (applicationName | lower) ~ ":$xdebug_port",
    rpcServer: "rpc_server_" ~ ( endpointData['store'] | lower ),
    zedHost: (endpoint | split(':') | first) ~ '$xdebug_mode',
    project: _context
} %}

{% endfor %}
{% endif %}
{% endfor %}
{% endfor %}
