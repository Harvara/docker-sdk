#!/bin/bash

set -e

pushd "${BASH_SOURCE%/*}" > /dev/null
. bin/constants.sh
. bin/console.sh
. bin/check-directories.sh
. bin/boot-deployment.sh

GIT_HASH=$(git rev-parse --verify HEAD || true)
popd > /dev/null

PROJECT_NAME=default

while getopts "vp:" opt;
do
    case ${opt} in
        v)
            VERBOSE=1
            ;;
        p)
            PROJECT_NAME=$OPTARG
            if [ "${PROJECT_NAME}" != "${PROJECT_NAME%[[:space:]]*}" ];
            then
                error "${WARN}The project name cannot contain spaces.${NC}"
                exit 1
            fi
            ;;
        *)
          ;;
    esac
done
shift $((OPTIND -1))

DESTINATION_DIR=${DESTINATION_DIR:-"${BASH_SOURCE%/*}/deployment/${PROJECT_NAME}"}
DEPLOYMENT_DIR="${BASH_SOURCE%/*}/deployment/_tmp"
readonly DEPLOY_SCRIPT=${DESTINATION_DIR}/deploy

function showHelp()
{
    echo -e ""
    echo -e "${INFO}Installation:${NC}"
    echo -e " $0 [-v] [-p <project-name=default>] bootstrap [<project-yml-file=deploy.yml>]"

    echo -e ""
    echo -e "${INFO}Quick start:${NC}"
    echo -e " $0 bootstrap && $0 up"
}

checkDirectories

command=$1
shift 1 || true

case "${command}" in
    boot|bootstrap)

        while getopts ":vs" opt; do
            case ${opt} in
                v)
                    export VERBOSE=1
                    ;;
                # Skip booting if same repo has same hash
                s)
                    SKIP_BOOTSTRAP_IF_DONE=1
                    ;;
                # Unknown argument specified
                \?)
                    Registry::printHelp
                    Console::error "Unknown argument ${INFO}-${OPTARG}${WARN} is acquired."
                    exit 1
                    ;;
                # Specified argument without required value
                :)
                    Registry::printHelp
                    Console::error "Option ${INFO}-${OPTARG}${WARN} requires an argument."
                    exit 1
                    ;;
            esac
        done
        shift $((OPTIND - 1))

        # ------------
        SOURCE_DIR=${BASH_SOURCE%/*}

        # ------------
        PROJECT_YAML=${1:-deploy.yml}

        if [ -n "${SKIP_BOOTSTRAP_IF_DONE}" ] && [ -f "${DESTINATION_DIR}/project.yml" ];
        then

            if cmp -s "${DESTINATION_DIR}/project.yml" "${PROJECT_YAML}"; then
                if [ "$(cat "${DESTINATION_DIR}/_git" 2>/dev/null || true)" == "${GIT_HASH}" ];
                then
                    echo -e "${CYAN}Bootstrap is skipped as the branch is still the same.${NC}" > /dev/stderr
                    echo -e "${DGRAY}Do not use ${LGRAY}-s${DGRAY} option to bootstrap anyway.${NC}" > /dev/stderr
                    exit 0
                fi
            fi
        fi

        if [ -f "${DEPLOY_SCRIPT}" ] && [ -z "${BOOT_IN_DEVELOPMENT}" ]; then
            echo -e -n "Stopping environment..." > /dev/stderr
            ${DEPLOY_SCRIPT} down >/dev/null 2>&1 && sleep 1 || true
            echo -e '[DONE]'
        fi

        # ------------
        [ -d "${DEPLOYMENT_DIR}" ] && rm -rf "${DEPLOYMENT_DIR}"
        mkdir "${DEPLOYMENT_DIR}"

        DEPLOYMENT_DIR="$( cd "${DEPLOYMENT_DIR}" >/dev/null 2>&1 && pwd )"

        # ------------
        validateParameters
        bootDeployment

        [ -d "${DESTINATION_DIR}" ] && rm -rf "${DESTINATION_DIR:?}/*"
        [ ! -d "${DESTINATION_DIR}" ] && mkdir "${DESTINATION_DIR}"
        cp -R "${DEPLOYMENT_DIR}/." "${DESTINATION_DIR}"
        rm -rf "${DEPLOYMENT_DIR}"

        echo -n "${GIT_HASH}" > "${DESTINATION_DIR}/_git"

        [ ! -f .dockerignore ] && cp "${BASH_SOURCE%/*}/.dockerignore.default" .dockerignore

        echo ""
        echo -e "${INFO}Deployment is generated into ${LGRAY}${DESTINATION_DIR}${NC}"
        echo -e "Use ${OK}docker/sdk$([ "${PROJECT_NAME}" != 'default' ] && echo -n " -p ${PROJECT_NAME}") up${NC} to start the application."

        ;;
    help|'')
        showHelp
        [ -f "${DEPLOY_SCRIPT}" ] && SPRYKER_SELF_SCRIPT=$0 ${DEPLOY_SCRIPT} help ${@}
        ;;
    *)
        [ ! -f "${DEPLOY_SCRIPT}" ] && showHelp && error "${WARN}The project is not initialized yet. Run ${YELLOW}$0 boot${WARN} before.${NC}" && exit 1
        SPRYKER_SELF_SCRIPT=$0 ${DEPLOY_SCRIPT} "${command}" ${@}
        ;;
esac
